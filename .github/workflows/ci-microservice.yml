name: Reusable CI - Microservice

on:
  workflow_call:
    inputs:
      service_dir:
        description: "Chemin du microservice (ex: backend/profilservice)"
        required: true
        type: string
      sonar_project_key:
        description: "Clé SonarCloud du projet"
        required: true
        type: string
      image_name:
        description: "Nom d'image Docker (sans registry)"
        required: true
        type: string

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: test
    defaults:
      run:
        working-directory: ${{ inputs.service_dir }}

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Java + cache Maven
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 3) Maven mirror + mvnw exécutable
      - name: Configure Maven Central mirror
        run: |
          mkdir -p ~/.m2
          cat <<'EOF' > ~/.m2/settings.xml
          <settings>
            <mirrors>
              <mirror>
                <id>central-fast</id>
                <name>Central Fast Mirror</name>
                <url>https://repo1.maven.org/maven2/</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          EOF
      - name: Make Maven Wrapper executable
        run: chmod +x mvnw

      # 4) Tests (toutes branches/PR)
      - name: Run Full Test Suite
        run: ./mvnw -B -ntp verify

      # 5) SonarCloud
      - name: SonarCloud Scan
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main' ||
          startsWith(github.ref, 'refs/heads/feature/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN:  ${{ secrets.SONAR_TOKEN }}
        run: |
          ./mvnw -B -ntp org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=nadia-2004 \
            -Dsonar.projectKey=${{ inputs.sonar_project_key }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=${{ inputs.service_dir }}/target/site/jacoco/jacoco.xml,${{ inputs.service_dir }}/target/site/jacoco-it/jacoco.xml \
            -Dsonar.java.binaries=target/classes

      # 6) Trivy — Scan FS
      - name: Trivy FS Scan (code & deps)
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main' ||
          startsWith(github.ref, 'refs/heads/feature/') ||
          github.event_name == 'workflow_dispatch'
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: ${{ inputs.service_dir }}/
          scanners: vuln,secret,misconfig
          format: table
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

      # 7) Build JAR
      - name: Build JAR
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main' ||
          startsWith(github.ref, 'refs/heads/feature/')
        run: ./mvnw -B -ntp clean package

      # 8) Build Docker Image (tag local)
      - name: Build Docker Image
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main' ||
          startsWith(github.ref, 'refs/heads/feature/')
        run: docker build -t ${{ inputs.image_name }}:0.0.1 .

      # 9) Trivy — Scan image
      - name: Trivy Image Scan
        if: |
          github.event_name == 'pull_request' ||
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ inputs.image_name }}:0.0.1
          scan-type: image
          scanners: vuln,secret,misconfig
          format: table
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
